### <a name="_b7urdng99y53"></a>**Название задачи: MVP архитектуры для платформы мониторинга скота** 
### <a name="_hjk0fkfyohdk"></a>**Автор: Сергей Бузунов**
### <a name="_uanumrh8zrui"></a>**Дата: 27.10.2025**
### <a name="_3bfxc9a45514"></a>**Функциональные требования**

|**№**|**Действующие лица или системы**|**Use Case**|**Описание**|
| UC-01 | Пользователь, платформа | Авторизация | 1. Пользователь вводит номер телефона и пароль. <br /> 2. Платформа отправляет СМС с кодом подтверждения. <br /> 3. Пользователь вводит код. <br /> 4. При успехе платформа отображает пользователю рабочее место |
| UC-01.01 | Техник, SCADA-система | Авторизация в SCADA-системе | 1. Техник вводит номер телефона и пароль. <br /> 2. SCADA-система отправляет СМС с кодом подтверждения. <br /> 3. Техник вводит код. <br /> 4. При успехе SCADA-система отображает рабочее место |
| UC-01.02 | Оператор, Трекер поголовья | Авторизация в Трекере поголовья | 1. Оператор вводит номер телефона и пароль. <br /> 2. Трекер отправляет СМС с кодом подтверждения. <br /> 3. Оператор вводит код. <br /> 4. При успехе Трекер отображает рабочее место |
| UC-01.03 | Менеджер, BI-система | Авторизация в BI-системе | 1. Менеджер вводит номер телефона и пароль. <br /> 2. BI-система отправляет СМС с кодом подтверждения. <br /> 3. Менеджер вводит код. <br /> 4. При успехе BI-система отображает рабочее место |
| UC-02 | IoT шлюз, ОпСоС, оператор | Оповещение | 1. IoT шлюз регистрирует аномальное состояние, поведение или количество животных. <br /> 2. IoT шлюз отправляет оператору СМС через оператора сотовой связи. <br /> 3. Оператор получает уведомление об инцидента |
| UC-02.01 | Оператор, Трекер поголовья | Мониторинг поголовья | 1. Оператор запрашивает список животных и их состояние. <br /> 2. Трекер отображает список животных |
| UC-03 | Техник, SCADA-система | Управление устройствами | 1. Техник запрашивает список устройств и их состояние. <br /> 2. SCADA-система отображает список устройкств. <br /> 3. Техник выбирает устройство и подает команду. <br /> 4. SCADA-система передает команду на устройство |
| UC-03.01 | Техник, SCADA-система | Управление кормушками | 1. Техник запрашивает список кормушек и их состояние. <br /> 2. SCADA-система отображает список кормушек. <br /> 3. Техник выбирает кормушку и подает подачи корма. <br /> 4. SCADA-система передает команду на кормушку |
| UC-03.02 | Техник, SCADA-система | Управление поилками | 1. Техник запрашивает список поилок и их состояние. <br /> 2. SCADA-система отображает список поилок. <br /> 3. Техник выбирает поилку и подает подачи воды. <br /> 4. SCADA-система передает команду на поилку |
| UC-03.03 | Техник, SCADA-система | Мониторинг фильтров | 1. Техник запрашивает список фильтров воды и их состояние. <br /> 2. SCADA-система отображает список фильтров |
| UC-04 | Менеджер, BI-система | Управление запасами | 1. Менеджер запрашивает запас кормов и прогноз расхода <br /> 2. BI-система выдает рекомендации для пополнения запаса кормов |
| UC-05 | Менеджер, BI-система | Пересчет животных | 1. Менеджер запрашивает список и характеристики животных <br /> 2. BI-система выдает список животных  |
| UC-06 | Менеджер, BI-система | Добавление метрики | 1. Менеджер добавляет и настраивает новую метрику <br /> 2. Новая метрика добавлена в систему |

### <a name="_u8xz25hbrgql"></a>**Нефункциональные требования**
|**№**|**Требование**|
| R-01 | Отказоустойчивость на уровне 99,95% |
| R-02 | После восстановления связи синхронизировать состояние между агентами и центральным сервером |
| R-03 | Отправляь уведомления операторам при отсутствии интернента |
| P-01 | Поддерживать неограниченное количество агентов |
| P-02 | Обеспечивать задержку не более 10 минут при синхронизации агента с сервером (без учета проблем со связью) |
| P-03 | От момента возникновения нештатной ситуации, зафиксированной с помощью видеоаналитики, должно проходить не более 5 секунд до момента оповещения оператора |
| P-04 | Позволять системе видеоаналитики реагировать в реальном времени (миллисекунды) |
| +R-01 | Платформа должна быть построена по принципу «центральный сервер — агенты» |
| +R-02 | На ферме нестабильный WiFi, поэтому нужно продумать альтернативные каналы связи |
| +R-03 | На каждой ферме допустимо использовать один центральный сервер и необходимый набор edge-устройств |

### <a name="_qmphm5d6rvi3"></a>**Решение**
### Описание
![Вариант №1](С2_Диаграмма_контейнеров_v1.png)
![Вариант №2](С2_Диаграмма_контейнеров_v2.png)

В проекте используется множество устройств разных производителей для управления и мониторинга устройств на ферме: кормушек, поилок, фильтров для воды. От устройств нужно получать данные и управлять ими. Т.к. у компании АгроПром Х в текущей цифровой платформе уже есть опыт организации управления устроствами с помощью SCADA-системы Ignition, а так же реализация и поддержка кода на Python для разнообразных устройств и датчиков тепличного хозяйства, решено переиспользовать этот подход. Дополнительно потребуется настройка SCADA-системы и разработка драйверов для новых устройств и датчиков.
В проекте используется видеокамеры с подключенной системой распознавания животных и аномального поведения. У компании АгроПром Х есть опыт реализации агента мониторинга урожая. Решено переиспользовать этот подход, подключив систему распознавания партнера и доработав код Python. 
Принято решение основное подключение вилеокамер выполнять через LAN. Это позволит гарантировано отслеживать инциденты при нестабильном WiFi-соединении. Т.к. ферма имеет ограниченную площат и несущие конструкции, монтаж проводной сети предпочтительнее использования 4G-подключения, которое может быть нестабильно. WiFi может использоваться для мониторинга в реальном времени и выгрузки видео партнеру для дообучения модели ИИ (не входит в MVP).     
В проекте используется RFID-метки для животных и датчики состояния животного.  У компании АгроПром Х есть опыт реализации подсистемы мониторинга на базе IoT-шлюза, базы временных рядов и Java-приложения мониторинга. Решено переиспользовать эту подсистему, разработав приложение Java для трекера поголовья на основе существующего приложения треккинга техники.
В качестве брокера сообщений используется RabbitMQ для передачи данных от агентов на центральный сервер. Это позволит использовать протокол MQTT для взаимодействия с устройствами. По сравнению с Kafka RabbitMQ проще в настройке и сопровождении, не требователен к ресурсам и обеспечивает необходимую производительность.
Для хранилища структурированных данных выбрана СУБД Click-House, опыт использования и интеграции с которой есть у АгроПром Х. Неструктурированные данные (видеопоток) решено не хранить. Для выгрузки видео партнеру для дообучения модели ИИ будет использоваться видеопоток с камер через WiFi (не входит в MVP).
В качестве аналитического модуля для отслеживания базовых и дополнительных метрик принято решение переиспользовать аналитический модуль АгроПром Х, написанный на Python, доработав его под новые структуры данных. В качестве системы мониторинга и настройки метрик принято решение переиспользовать Power BI в качестве BI-системы. В аналитическом модуле также необходимо будет доработать выгрузку метрик во внешние системы и поддержку API интеграции с Web/Mobile-приложением.
Оповещение оператора об инцидентах реализовано в приложении "Трекер поголовья" через интеграцию с GSM-модемом. Это позволит реализовать оперативное оповещение вне зависимости от наличия WiFi/интернет.
Рабочие места техников и операторов расположены на агентах EDGE, что позволяет исключить зависимость от перебоев связи.

### Аргументация
| Критерий         | Обоснование                 |
|------------------|-----------------------------|
| Functional       | Поддержка отложенной обработки и повторных попыток  |
| Performance |	Обеспечивает пропускную способность 10K сообщений/сек |
| Reliability	| Наличие DLQ гарантирует, что сообщения не потеряются |

#### Последствия

**✅ Положительные:**
- Возможность оперативного мониторинга, управления и реагирования на инцеденты при отсутствии связи с центральным цервером платформы
- Улучшение масштабируемости системы за счет кластеризации брокера сообщения
- Простота настройки и администирования брокера RabitMQ
- Снижение затрат на поддержку и ресурсы
**⚠️ Негативные:**
- Отсутствие централизованного управления пользователями и биллинга расходов на SMS-оповещение
- Необходимость изучения RabbitMQ
- Снижение максимальной пропускной способности
- Необходимость низкоуровневой интеграции в GSM-модемами

**↗️ Зависимости:**
- Требуется обновить сервисы агентов
- Требуется перенастроить хранилище данных 
- Требуется разработать модуль интеграции с GSM-модемом

### <a name="_bjrr7veeh80c"></a>**Альтернативы**
При более высокой нагрузке в качестве брокера лучше использовать брокер Kafka.
Рабочие места операторов и техников можно реализовать на сервере головной компании, с подключением через мобильное приложение. Это даст возможность централизовать систему аутентификации, в дальнейшем интегрировать с приложение с ERP-системой, но снизит опреативность мониторинга и управления устройствами при проблемах со связью.
Оповещение операторов об инцидентах можно реализовать на сервере головной компании, с передачей сообщений по SMPP. Это снизит затраты на оповещение, позволит отслеживать биллинг оператора, но может критически снизить оперативность оповещения при проблемах со связью.

**Недостатки, ограничения, риски**
Разные типы пользователей работают с разными приложениями, нет единой системы аутентификации, нет централизованной системы управления пользователями.
При использовании GSM-модемов нНет возможности снижения затрат на оповещение посредством SMPP-интеграции с провайдерос сотовой связи или перехода на Push-уведомления в мобильном приложении. Нет единой системы биллинга и контроля за расходами на оповещение.

#### Рекомендации
Рекомендую реализовать рабочие места оперативных сотрудников и оповещение об инцидентах на агентах. В случае продолжительного отсутствиия связи при централизации оповещения и рабочих мест оперативное управление может стать невозможным. В то же время решение можно будет в дальнейшем дополнить вторым контуром управления через центральную платформу, отсавив текущее решение в качестве резервного на случай проблем с интернетом.   
Рекомендую использовать в качестве брокера сообщений RabbitMQ




